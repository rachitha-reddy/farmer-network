<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Messages | Farmer Network</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      background: #f3f9f1;
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
    }
    .site-header {
      background: #38a653;
    }
    .container.header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: 96px;
      padding-right: 96px;
    }
    .brand-left {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 54px;
      height: 54px;
      border-radius: 12px;
      margin-right: 14px;
    }
    .brand-left h1 {
      font-size: 2em;
      color: #fff;
      font-weight: 700;
      margin: 0;
      letter-spacing: 1px;
    }
    .nav {
      display: flex;
      gap: 28px;
    }
    .nav a {
      font-weight: 700;
      font-size: 1.17em;
      color: #fff;
      text-decoration: none;
      transition: border-bottom 0.18s;
      padding: 24px 0;
    }
    .nav a.active, .nav a:hover {
      border-bottom: 3px solid #e3f1de;
      color: #e0faea;
    }
    .messages-layout {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 81vh;
      margin-top: 34px;
      gap: 0;
    }
    .messages-sidebar {
      background: #fff;
      width: 335px;
      min-width: 260px;
      max-width: 370px;
      border-right: 1.5px solid #e1eee4;
      min-height: 610px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 22px 25px 14px 25px;
      font-size: 1.22em;
      font-weight: 700;
      color: #24763b;
      background: #fff;
      border-bottom: 1.5px solid #e1eee4;
      letter-spacing: .3px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-header .fa-edit {
      font-size: 1.15em;
      color: #219653;
      cursor: pointer;
      margin-left: 10px;
    }
    .sidebar-search {
      width: 92%;
      margin: 12px auto 8px auto;
      background: #f2f8f2;
      border-radius: 19px;
      display: flex;
      align-items: center;
      position: relative;
    }
    .sidebar-search .fa-search {
      color: #38a653;
      margin-left: 13px;
      font-size: 1.1em;
    }
    .sidebar-search input {
      border: none;
      background: none;
      padding: 13px 16px 13px 9px;
      width:93%;
      font-size: 1.11em;
      border-radius: 18px;
      outline: none;
      color: #25713e;
    }
    .search-suggestions-list {
      position: absolute;
      left: 0;
      right: 0;
      top: 38px;
      width: 100%;
      background: #fff;
      border: 1px solid #cde4c1;
      z-index: 20;
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 190px;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 5px 16px rgba(41,86,53,0.09);
      display: none;
    }
    .search-suggestions-list li {
      padding: 12px 23px;
      cursor: pointer;
      color: #295f31;
      font-size: 1em;
    }
    .search-suggestions-list li:hover {
      background: #f0f9ed;
    }
    .stories-row {
      display: flex;
      gap: 13px;
      margin: 10px 0 14px 16px;
      overflow-x: auto;
      padding-bottom: 6px;
    }
    .story-avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: 2.5px solid #77cc9c;
      object-fit: cover;
      margin-bottom: 6px;
    }
    .story-name {
      text-align: center;
      font-size: 0.89em;
      color: #29664a;
      width: 66px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .contacts-list {
      flex: 1;
      overflow-y: auto;
      padding-top: 4px;
    }
    .contact-item {
      display: flex;
      align-items: center;
      padding: 13px 20px 13px 18px;
      transition: background 0.1s;
      cursor: pointer;
      border-bottom: 1.5px solid #f3f6f2;
    }
    .contact-item:hover, .contact-item.active {
      background: #eafbe6;
    }
    .contact-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      border: 2px solid #4ac467;
      object-fit: cover;
      margin-right: 13px;
    }
    .contact-info {
      flex: 1;
    }
    .contact-name {
      font-size: 1.09em;
      font-weight: 600;
      color: #208048;
      margin-bottom: 2px;
    }
    .contact-msg {
      font-size: .99em;
      color: #7a9982;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .msg-dot {
      width: 9px; height: 9px; display: inline-block;
      border-radius: 50%; background: #62dd1e;
      margin-left: 10px; margin-bottom: 2px;
    }
    /* Chat Window */
    .messages-main-box {
      background: #f8fcfb;
      flex: 1 1 600px;
      min-width: 520px;
      min-height: 610px;
      display: flex;
      flex-direction: column;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 20px rgba(60,80,67,.09);
      margin-left: 0;
      transition: opacity .25s;
    }
    .chat-header {
      padding: 22px 38px 18px 38px;
      font-size: 1.20em;
      font-weight: 700;
      color: #217d4e;
      border-bottom: 1.5px solid #e1eee4;
      display: flex;
      align-items: center;
      gap: 13px;
    }
    .chat-header img {
      width: 43px; height: 43px; border-radius: 50%; margin-right: 8px; border:2px solid #51ce78;
    }
    .chat-header .profile-user {
      color: #217d4e;
      font-size: 1.07em;
      font-weight: 700;
    }
    .chat-thread {
      flex: 1;
      overflow-y: auto;
      padding: 42px 38px 8px 38px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      background: #fafdff;
    }
    .chat-message {
      max-width: 60%;
      padding: 16px 28px;
      border-radius: 16px 16px 16px 6px;
      font-size: 1.10em;
      background: #e9fbe4;
      color: #265c2f;
      align-self: flex-start;
      box-shadow: 0 2px 8px rgba(62,118,71,0.10);
      word-break: break-word;
      transition:background 0.13s;
    }
    .chat-message.me {
      align-self: flex-end;
      background: #38a653;
      color: #fff;
      border-radius: 16px 16px 6px 16px;
    }
    .chat-time {
      font-size: 0.95em;
      color: #92aa99;
      margin-top: 6px;
      margin-bottom: 0;
      text-align: right;
      margin-right: 3px;
    }
    /* Chat input and send */
    .chat-input-row {
      display: flex;
      align-items: center;
      padding: 18px 30px 22px 30px;
      border-top: 1.5px solid #e1eee4;
      background: #fafdff;
      gap: 10px;
      position: relative;
    }
    .chat-input {
      flex: 1;
      border: none;
      background: #f3f6f2;
      font-size: 1.15em;
      border-radius: 14px;
      padding: 16px 24px;
      outline:none;
      margin-right: 7px;
      transition: box-shadow .1s;
    }
    .chat-input:focus {
      box-shadow: 0 0 4px #38a65355;
    }
    .chat-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.43em;
      color: #60c476;
      margin-right: 2px;
    }
    .chat-photo-btn {
      font-size: 1.3em;
      color: #38a653;
      margin-right: 8px;
    }
    .chat-send-btn {
      background: #38a653;
      border: none;
      border-radius: 12px;
      padding: 11px 21px;
      margin-left: 5px;
      cursor: pointer;
      transition: background .18s;
      display: flex;
      align-items: center;
      justify-content: center;
      outline: none;
      box-shadow: 0 2px 6px #38a6532e;
    }
    .chat-send-btn:hover {
      background: #25843b;
    }
    .chat-send-btn i {
      font-size: 1.27em;
      margin: 0 2px;
      vertical-align: -1px;
    }
    /* Emoji picker styles */
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      left: 64px;
      background: #fff;
      border: 1.4px solid #dfedd9;
      border-radius: 13px;
      box-shadow: 0 3px 20px rgba(62,118,71,0.16);
      z-index: 24;
      width: 285px;
      max-height: 220px;
      padding: 18px 20px 10px 18px;
      display: none;
      flex-wrap: wrap;
      gap: 14px 10px;
      overflow-y: auto;
    }
    .emoji-picker span {
      font-size: 1.28em;
      cursor: pointer;
      transition: background .12s;
      border-radius: 7px;
      padding: 2px 6px 5px 6px;
    }
    .emoji-picker span:hover {
      background: #e8f9ea;
    }
    #chat-image-input {
      display: none;
    }
    .chat-image-label {
      display: inline-block;
      font-size: 1.37em;
      color: #1cb157;
      margin-left: 0;
      margin-right: 2px;
      cursor: pointer;
    }
    .messages-blank-box {
      background: #fff;
      flex: 1 1 600px;
      min-width: 520px;
      min-height: 610px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 20px rgba(60,80,67,.09);
      margin-left: 0;
    }
    .blank-msg-center {
      text-align: center;
      color: #25713e;
      font-size: 1.35em;
      font-weight: 600;
      opacity: 0.70;
      user-select: none;
    }
    @media (max-width:900px) {
      .container.header-flex {padding-left:14px;padding-right:14px;}
      .messages-layout{gap:0;}
      .messages-main-box, .messages-blank-box{min-width:180px;}
      .sidebar-header{padding-left:10px;padding-right:10px;}
      .messages-sidebar{max-width:160px;min-width:100px;width:160px;}
    }
    @media (max-width:700px){
      .container.header-flex{padding-left:0;padding-right:0;}
      .messages-layout{flex-direction:column;}
      .messages-sidebar,.messages-main-box,.messages-blank-box{width:99vw;min-width:0;}
      .messages-main-box,.messages-blank-box{margin-left:0;}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-flex">
    <div class="brand-left">
      <img src="img.jpg" alt="Logo" class="logo" />
      <h1>Farmer Network</h1>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="profile.html">Profile</a>
      <a href="messages.html" class="active">Messages</a>
      <a href="weather.html">Weather</a>
      <a href="resources.html">Resources</a>
      <a href="community.html">Community</a>
      <a href="tips.html">Tips</a>
      <a href="Feedback.html">Feedback</a>
    </nav>
  </div>
</header>

<div class="messages-layout">
  <div class="messages-sidebar">
    <div class="sidebar-header">
      <span id="sidebarCurrentUser"></span>
      <i class="fa fa-edit" id="newMessageBtn" title="New Message" style="cursor: pointer;"></i>
    </div>
    <div class="sidebar-search">
      <i class="fa fa-search"></i>
      <input id="sidebarUserSearch" type="text" autocomplete="off"/>
      <ul id="sidebarSearchSuggestions" class="search-suggestions-list"></ul>
    </div>

    <!-- contacts will be injected dynamically -->
    <div class="contacts-list" id="contactList"></div>
  </div>

  <div class="messages-main-box" id="messagesMainBox">
    <div class="chat-header">
      <img src="" id="chatHeaderAvatar" />
      <span class="profile-user" id="chatWith"></span>
    </div>

    <!-- empty chat thread; messages added dynamically -->
    <div class="chat-thread" id="chatThread"></div>

    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <button class="chat-action-btn" type="button" id="showEmojiPicker" title="Insert emoji">
        <i class="fa-regular fa-face-smile"></i>
      </button>
      <div style="position: relative;">
        <label for="chat-image-input" class="chat-image-label" title="Send image/video">
          <i class="fa-regular fa-image"></i>
        </label>
        <input type="file" id="chat-image-input" accept="image/*,video/*"/>
      </div>
      <input type="text" id="chatInput" class="chat-input" placeholder="Message..." />
      <button class="chat-send-btn" type="submit" title="Send">
        <i class="fa-regular fa-paper-plane"></i>
      </button>
      <div class="emoji-picker" id="emojiPicker">
        <span>üòä</span><span>üòÅ</span><span>üòÇ</span><span>üòÖ</span>
        <span>ü§£</span><span>üôÇ</span><span>üòâ</span><span>üòç</span>
        <span>ü•∞</span><span>üòé</span><span>ü§ó</span><span>ü§©</span>
        <span>üò≠</span><span>üòá</span><span>üòú</span><span>ü§î</span>
        <span>üôè</span><span>üëç</span><span>üå±</span><span>üåæ</span>
        <span>üçÖ</span><span>üçç</span><span>ü•¶</span><span>üåª</span>
        <span>üî•</span><span>üíØ</span><span>‚ù§Ô∏è</span>
      </div>
    </form>
  </div>

  <div class="messages-blank-box" id="messagesBlankBox" style="display:none;">
    <div class="blank-msg-center">
      Your messages will be displayed here
    </div>
  </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:4000';

// Check authentication
const token = localStorage.getItem('token');
if (!token) {
  window.location.href = 'login.html';
}

// Helper function to get auth headers
function getAuthHeaders() {
  const token = localStorage.getItem('token');
  return {
    'Content-Type': 'application/json',
    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
  };
}

// Load current user info
const currentUser = localStorage.getItem('username') || 'User';
document.getElementById('sidebarCurrentUser').textContent = currentUser;

// Usernames array - will be populated from API
let usernames = []; // [{ handle, name, img, conversationId, lastMessage }, ...]

// Active conversation ID
let activeConversationId = null;

// Load conversations from API
async function loadConversations() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/conversations?user=${encodeURIComponent(currentUser)}`);
    
    if (res.status === 401) {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
      return;
    }
    
    if (!res.ok) {
      throw new Error('Failed to load conversations');
    }
    
    const data = await res.json();
    usernames = data.conversations.map(conv => {
      const other = conv.participants.find(p => p !== currentUser);
      if (!other) return null; // Skip if no other participant found
      const handle = other.startsWith('@') ? other : `@${other}`;
      const img = conv.avatarMap && conv.avatarMap[other] ? (conv.avatarMap[other].startsWith('http') ? conv.avatarMap[other] : API_BASE_URL + conv.avatarMap[other]) : "";
      return {
        handle,
        name: other,
        img,
        conversationId: conv._id,
        lastMessage: conv.lastMessage || ""
      };
    }).filter(u => u !== null); // Remove null entries
    
    fillContacts();
  } catch (err) {
    console.error('Error loading conversations:', err);
  }
}

// Fill contacts list from usernames array
let chatBoxVisible = true;
function fillContacts(filter = '') {
  const el = document.getElementById('contactList');
  el.innerHTML = '';
  const found = usernames.filter(u => u.handle && u.handle.toLowerCase().includes(filter.toLowerCase()));
  found.forEach(({ handle, img, lastMessage, conversationId }, i) => {
    const li = document.createElement('div');
    li.className = 'contact-item' + (i === 0 && !activeConversationId ? ' active' : '');
    li.innerHTML = `
      <img src="${img || ''}" class="contact-avatar"/>
      <div class="contact-info">
        <div class="contact-name">${handle || ''}</div>
        <div class="contact-msg">${lastMessage || ''}</div>
      </div>
    `;
    
    // Store conversationId on contact element
    li.dataset.conversationId = conversationId;
    
    let lastClick = 0;
    li.onclick = async function() {
      const now = Date.now();
      if (now - lastClick < 350) {
        // double click toggles chat panel / blank panel
        chatBoxVisible = !chatBoxVisible;
        document.getElementById('messagesMainBox').style.display = chatBoxVisible ? '' : 'none';
        document.getElementById('messagesBlankBox').style.display = chatBoxVisible ? 'none' : '';
        return;
      }
      lastClick = now;

      document.querySelectorAll('.contact-item').forEach(a => a.classList.remove('active'));
      li.classList.add('active');

      document.getElementById('chatWith').textContent = handle || '';
      document.getElementById('chatHeaderAvatar').src = img || '';
      
      // Read conversationId from dataset
      const convId = li.dataset.conversationId;
      if (convId) {
        activeConversationId = convId;
        await loadMessages(convId);
      } else {
        document.getElementById('chatThread').innerHTML = ``;
      }

      if (!chatBoxVisible) {
        document.getElementById('messagesMainBox').style.display = '';
        document.getElementById('messagesBlankBox').style.display = 'none';
        chatBoxVisible = true;
      }
    };
    el.appendChild(li);
  });
}

// Load conversations on page load
document.addEventListener('DOMContentLoaded', loadConversations);

// New message button - opens search to start new conversation
document.getElementById('newMessageBtn').onclick = function() {
  sidebarUserSearch.focus();
  sidebarUserSearch.click();
};

// Sidebar username search logic - searches all users
const sidebarUserSearch = document.getElementById('sidebarUserSearch');
const sidebarSuggestions = document.getElementById('sidebarSearchSuggestions');
let searchTimeout = null;

sidebarUserSearch.addEventListener('input', function() {
  const val = sidebarUserSearch.value.trim();
  sidebarSuggestions.innerHTML = '';
  
  // Clear previous timeout
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }
  
  if (val.length === 0) {
    sidebarSuggestions.style.display = 'none';
    fillContacts();
    return;
  }
  
  // Debounce search
  searchTimeout = setTimeout(async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/api/users/search?q=${encodeURIComponent(val)}`, {
        headers: getAuthHeaders()
      });
      
      if (res.status === 401) {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
        return;
      }
      
      if (!res.ok) {
        throw new Error('Failed to search users');
      }
      
      const data = await res.json();
      const users = data.users || [];
      
      if (users.length === 0) {
        sidebarSuggestions.style.display = 'none';
        return;
      }
      
      users.forEach(user => {
        const li = document.createElement('li');
        const displayName = user.fullName || user.username;
        li.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${user.avatarUrl ? (user.avatarUrl.startsWith('http') ? user.avatarUrl : API_BASE_URL + user.avatarUrl) : ''}" 
                 style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #4ac467;" />
            <span>${displayName}</span>
          </div>
        `;
        li.onclick = async () => {
          sidebarUserSearch.value = '';
          sidebarSuggestions.style.display = 'none';
          await startConversation(user.username, user.fullName || user.username, user.avatarUrl || '');
        };
        sidebarSuggestions.appendChild(li);
      });
      
      sidebarSuggestions.style.display = 'block';
    } catch (err) {
      console.error('Error searching users:', err);
    }
  }, 300);
});

document.body.addEventListener('click', function(e) {
  if (!sidebarUserSearch.contains(e.target) && !sidebarSuggestions.contains(e.target)) {
    sidebarSuggestions.style.display = 'none';
  }
});

// Function to start a new conversation with a user
async function startConversation(username, displayName, avatarUrl) {
  try {
    const res = await fetch(`${API_BASE_URL}/api/conversations`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ participants: [currentUser, username] })
    });
    
    if (res.status === 401) {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
      return;
    }
    
    if (!res.ok) {
      const error = await res.json();
      alert('Failed to start conversation: ' + (error.error || 'Unknown error'));
      return;
    }
    
    const data = await res.json();
    const conversation = data.conversation;
    
    // Update active conversation
    activeConversationId = conversation._id;
    
    // Update chat header
    const handle = username.startsWith('@') ? username : `@${username}`;
    document.getElementById('chatWith').textContent = handle;
    document.getElementById('chatHeaderAvatar').src = avatarUrl ? (avatarUrl.startsWith('http') ? avatarUrl : API_BASE_URL + avatarUrl) : '';
    
    // Load messages (will be empty for new conversation)
    await loadMessages(conversation._id);
    
    // Show chat box
    document.getElementById('messagesMainBox').style.display = '';
    document.getElementById('messagesBlankBox').style.display = 'none';
    chatBoxVisible = true;
    
    // Reload conversations to update the list
    await loadConversations();
  } catch (err) {
    console.error('Error starting conversation:', err);
    alert('Failed to start conversation. Please try again.');
  }
}

// Emoji picker logic
const emojiPicker = document.getElementById('emojiPicker');
document.getElementById('showEmojiPicker').onclick = function(e) {
  e.preventDefault();
  emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
};
emojiPicker.querySelectorAll('span').forEach(function(span){
  span.onclick = function(){
    document.getElementById('chatInput').value += span.textContent;
    emojiPicker.style.display = 'none';
    document.getElementById('chatInput').focus();
  };
});
document.body.addEventListener('click', function(e){
  if(!emojiPicker.contains(e.target) &&
     e.target.id !== 'showEmojiPicker' &&
     e.target.className !== 'fa-regular fa-face-smile'){
    emojiPicker.style.display = 'none';
  }
});

// Load messages for a conversation
async function loadMessages(conversationId) {
  try {
    const res = await fetch(`${API_BASE_URL}/api/conversations/${conversationId}/messages`);
    
    if (res.status === 401) {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
      return;
    }
    
    if (!res.ok) {
      throw new Error('Failed to load messages');
    }
    
    const data = await res.json();
    const threadEl = document.getElementById('chatThread');
    threadEl.innerHTML = "";
    
    data.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'chat-message' + (msg.sender === currentUser ? ' me' : '');
      div.textContent = msg.text;
      threadEl.appendChild(div);
    });
    
    threadEl.scrollTop = threadEl.scrollHeight;
  } catch (err) {
    console.error('Error loading messages:', err);
  }
}

// Message sending logic
async function sendMessage(e) {
  e.preventDefault();
  const chatInput = document.getElementById('chatInput');
  const text = chatInput.value.trim();
  
  if (!text || !activeConversationId) {
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE_URL}/api/conversations/${activeConversationId}/messages`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ text })
    });
    
    if (res.status === 401) {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
      return;
    }
    
    if (!res.ok) {
      const error = await res.json();
      alert('Failed to send message: ' + (error.error || 'Unknown error'));
      return;
    }
    
    const data = await res.json();
    
    // Append the new message to chatThread
    const chatThread = document.getElementById('chatThread');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message me';
    msgDiv.textContent = data.message.text;
    chatThread.appendChild(msgDiv);
    chatThread.scrollTop = chatThread.scrollHeight;
    
    // Clear input
    chatInput.value = '';
    
    // Reload conversations to update lastMessage
    await loadConversations();
  } catch (err) {
    console.error('Error sending message:', err);
    alert('Failed to send message. Please try again.');
  }
}

// Attach submit handler to chatForm
document.getElementById('chatForm').addEventListener('submit', sendMessage);

// Sending images - TODO: Implement image upload to backend
document.getElementById('chat-image-input').onchange = function(e) {
  const file = e.target.files[0];
  if(file && activeConversationId) {
    // For now, send as text message with file name
    // TODO: Implement actual image upload to backend
    const chatInput = document.getElementById('chatInput');
    chatInput.value = 'üì∑ ' + file.name;
    sendMessage(e);
  }
  e.target.value = '';
};
</script>
</body>
</html>
