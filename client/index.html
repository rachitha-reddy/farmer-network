<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmer Network</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      margin: 0;
      background: #f3f9f1;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .site-header {
      background: #38a653;
      padding: 0;
    }
    .container.header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: 96px;   /* 1 inch gap on left */
      padding-right: 96px;  /* 1 inch gap on right for nav */
      max-width: 100vw;
    }
    .brand-left {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 54px;
      height: 54px;
      border-radius: 12px;
      margin-right: 14px;
    }
    .brand-left h1 {
      font-size: 2em;
      color: #fff;
      font-weight: 700;
      margin: 0;
      letter-spacing: 1px;
    }
    .nav {
      display: flex;
      gap: 28px;
    }
    .nav a {
      font-weight: 700;
      font-size: 1.17em;
      color: #fff;
      text-decoration: none;
      transition: border-bottom 0.18s;
      padding: 24px 0;
    }
    .nav a:hover, .nav a.active {
      border-bottom: 3px solid #e3f1de;
      color: #e0faea;
    }
    /* Main grid and layout */
    .main-grid {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 78px;
      margin-top: 32px;
      min-height: 82vh;
    }
    .left-col {
      flex: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 830px;
    }
    .centered-search-bar {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-bottom: 25px;
    }
    .search-user-bar {
      width: 100%;
      max-width: 600px;
      position: relative;
    }
    #userSearchInput {
      width: 100%;
      padding: 16px 22px;
      font-size: 1.27em;
      border: 1.8px solid #127042;
      border-radius: 10px;
      outline: none;
      background: #fafefa;
      color: #1b3c21;
      box-sizing: border-box;
      margin:0 auto;
      display: block;
    }
    .sample-post {
      border: 2.5px solid #111;
      border-radius: 0px;
      padding: 54px 58px 44px 58px;
      background: #fff;
      margin-bottom: 38px;
      width: 100%;
      max-width: 800px;
      box-shadow: 0px 5px 20px rgba(0,0,0,0.08);
      position: relative;
    }
    .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .avatar {
      width: 52px; height: 52px;
      border-radius: 50%;
      object-fit: cover;
      border: 2.5px solid #2f8f3a;
    }
    .username {
      font-weight: 700;
      font-size: 1.24em;
      color: #127042;
    }
    .image-carousel {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
    }
    .carousel-arrow {
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
      color: #156343;
      padding: 9px 14px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .carousel-arrow:active {
      background: #eafbe6;
    }
    .left-arrow { margin-right: 18px; }
    .right-arrow { margin-left: 18px; }
    #postImage {
      max-width: 600px;
      max-height: 400px;
      border-radius: 0px;
      border: 1.5px solid #dbe9d4;
      box-shadow: 0 4px 14px rgba(60,80,67,.11);
      background: #f8faf7;
      margin: 0 14px;
    }
    .action-bar {
      display: flex;
      align-items: center;
      gap: 14px;
      margin:18px 0 12px 0;
      font-size: 1.27em;
      color:#111;
      font-weight:500;
      user-select:none;
    }
    .action-btn {
      background: none;
      border: none;
      padding: 3px 11px 3px 1px;
      cursor: pointer;
      font-size: 1.27em;
      margin-right: 2px;
      vertical-align: middle;
    }
    .action-bar .like-count, .action-bar .comment-count {
      font-size:1.07em;
      font-weight:500;
      margin-left:4px;
      margin-right: 18px;
      vertical-align:middle;
    }
    .action-bar .comment-count { margin-left: 2px; }
    .action-bar .like-label, .action-bar .comment-label {
      margin-left: 1px;
      font-weight:500;
      font-size:1.09em;
      margin-right:2px;
      vertical-align:middle;
    }
    .right-col {
      flex: none;
      width: 440px;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 60px; /* 3in - margin depends on grid gap */
    }
    .suggestions-widget {
      background: #fff;
      border: 1.5px solid #d1e8d4;
      border-radius: 0px;
      box-shadow: 0px 3px 10px rgba(41,86,53,0.07);
      padding: 38px 36px 28px 35px;
      margin-top: 6px;
      width: 100%;
      max-width: 440px;
      min-width: 350px;
    }
    .suggestions-widget h2 {
      margin-top: 0;
      font-size: 1.48em;
      color: #1a814c;
      border-bottom: 1px solid #e3e9e6;
      padding-bottom: 18px;
      margin-bottom: 22px;
      font-weight: 700;
    }
    .suggestions-widget ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .suggestions-widget li {
      padding: 15px 0;
      font-size: 1.22em;
      color: #28563e;
      border-bottom: 1px solid #f2f3ef;
      font-weight: 600;
    }
    .suggestions-widget li:last-child {
      border-bottom: none;
    }
    .search-suggestions-list {
      position: absolute;
      top: 52px;
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid #cde4c1;
      border-top: none;
      z-index: 12;
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 170px;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 5px 16px rgba(41,86,53,0.09);
      display: none;
      font-size: 1.15em;
    }
    .search-suggestions-list li {
      padding: 14px 23px;
      cursor: pointer;
      color: #295f31;
    }
    .search-suggestions-list li:hover {
      background: #f0f9ed;
    }
    .post-community-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #38a653;
      color: #fff;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: capitalize;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-flex">
      <div class="brand-left">
        <img src="img.jpg" alt="Logo" class="logo" />
        <h1>Farmer Network</h1>
      </div>
      <nav class="nav">
        <a href="index.html" id="homeNav" class="active">Home</a>
        <a href="profile.html" id="profileNav">Profile</a>
        <a href="messages.html" id="messagesNav">Messages</a>
        <a href="weather.html" id="weatherNav">Weather</a>
        <a href="resources.html" id="ResourceNav">Resources</a>
        <a href="community.html" id="Community">Community</a>
        <a href="tips.html" id="tipsNav">Tips</a>
        <a href="Feedback.html" id="feedbackNav">Feedback</a>
        <a href="login.html" id="loginNav">Login</a>
      </nav>
    </div>
  </header>
  <div class="container main-grid">
  <div class="left-col">
    <div class="centered-search-bar">
      <div class="search-user-bar">
        <input type="text" id="userSearchInput" autocomplete="off" />
        <ul id="searchSuggestions" class="search-suggestions-list"></ul>
      </div>
    </div>
    

    <!-- Posts container - posts will be dynamically inserted here -->
    <div id="postsContainer"></div>
  </div>

  <!-- Right column stays exactly as before -->
  <div class="right-col">
    <div class="suggestions-widget">
      <h2>Suggestions</h2>
      <ul id="suggestionsList">
        <!-- Suggestions will be loaded from backend -->
      </ul>
    </div>
  </div>
</div>
  
  </div>
  <footer class="footer">
    <p>&copy; 2025 NovaTech | Helpline: +1234567890 | Email: support@novatech.com</p>
  </footer>
  <script>
    const API_BASE_URL = 'http://localhost:4000';
    
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }
    
    // Helper function to get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      };
    }
    
    // Logout functionality
    function setupLogout() {
      const loginNav = document.getElementById('loginNav');
      if (loginNav) {
        const username = localStorage.getItem('username') || 'User';
        loginNav.innerHTML = `<i class="fa fa-right-to-bracket"></i> Logout (${username})`;
        loginNav.onclick = (e) => {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('username');
          localStorage.removeItem('userId');
          localStorage.removeItem('fullName');
          localStorage.removeItem('avatarUrl');
          window.location.href = 'login.html';
        };
      }
    }
    setupLogout();

    // Placeholder image URL for posts without images
    // TODO: Replace with actual file upload integration
    const PLACEHOLDER_IMAGE_URL = 'https://via.placeholder.com/600x400?text=No+Image';

    // Fetch posts and display (home feed - only followed users)
    async function loadPosts(communityFilter = '') {
      try {
        // Home feed uses /api/posts/feed to show only followed users' posts
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/posts/feed`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }
        
        if (!res.ok) {
          throw new Error('Failed to load posts');
        }
        
        const data = await res.json();
        const posts = data.posts || [];
        
        // Clear existing posts container
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = '';
        
        if (posts.length === 0) {
          postsContainer.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em; padding: 40px;">No posts yet. Follow some users to see their posts!</p>';
          return;
        }
        
        // Render each post
        posts.forEach((post, index) => {
          renderPost(post, index);
        });
      } catch (e) {
        console.error('Error loading posts', e);
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = '<p style="text-align: center; color: #d32f2f; font-size: 1.2em; padding: 40px;">Failed to load posts. Please try again.</p>';
      }
    }

    // Render a single post
    function renderPost(post, index) {
      const postsContainer = document.getElementById('postsContainer');
      const postDiv = document.createElement('div');
      postDiv.className = 'sample-post';
      postDiv.id = `post-${index}`;
      
      // Build image URLs (prepend API_BASE_URL if relative, use placeholder if empty)
      const images = post.images && post.images.length > 0 
        ? post.images.map(img => img.startsWith('http') ? img : API_BASE_URL + img)
        : [PLACEHOLDER_IMAGE_URL];
      let currentImgIndex = 0;
      
      // Build image URLs (prepend API_BASE_URL if relative)
      const imageUrls = images.map(img => img.startsWith('http') ? img : API_BASE_URL + img);
      
      // Check if current user owns this post
      const currentUsername = localStorage.getItem('username');
      const isOwner = post.username === currentUsername;
      const deleteButton = isOwner ? `<button class="delete-post-btn" id="deleteBtn-${index}" title="Delete post" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: auto; font-size: 0.9em;">üóëÔ∏è Delete</button>` : '';
      
      // Store post ID for deletion
      postDiv.dataset.postId = post._id || post.id;
      
      postDiv.innerHTML = `
        <div class="user-row" style="display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" class="user-profile-link" data-username="${post.username || ''}">
            <img class="avatar" src="${post.avatarUrl ? (post.avatarUrl.startsWith('http') ? post.avatarUrl : API_BASE_URL + post.avatarUrl) : ''}" alt="User photo" />
            <span class="username">${post.username || ''}</span>
          </div>
          ${deleteButton}
        </div>
        ${post.community ? `<div class="post-community-badge">${post.community}</div>` : ''}
        <div class="image-carousel">
          <button class="carousel-arrow left-arrow" id="prevImgBtn-${index}">&#8592;</button>
          <img id="postImage-${index}" src="${imageUrls[currentImgIndex]}" alt="Post image" />
          <button class="carousel-arrow right-arrow" id="nextImgBtn-${index}">&#8594;</button>
        </div>
        <div class="action-bar">
          <button class="action-btn" id="likeBtn-${index}" title="Like">
            <span id="likeIcon-${index}">ü§ç</span>
          </button>
          <span class="like-label">Like</span>
          <span class="like-count" id="likeCount-${index}">(0)</span>
          <button class="action-btn" id="commentBtn-${index}" title="Comments">
            <span>üí¨</span>
          </button>
          <span class="comment-label">Comment</span>
          <span class="comment-count" id="commentCount-${index}">(0)</span>
        </div>
        <div class="post-footer">
          <div class="post-footer-username user-profile-link" data-username="${post.username || ''}" style="cursor: pointer;">${post.username || ''}</div>
          <div class="post-caption">
            <span class="caption-username user-profile-link" data-username="${post.username || ''}" style="cursor: pointer;">${post.username || ''}</span>
            <span class="caption-text">${post.caption || ''}</span>
          </div>
        </div>
      `;
      
      // Store post ID for deletion
      postDiv.dataset.postId = post._id;
      
      postsContainer.appendChild(postDiv);
      
      // Add click handlers for profile links
      const profileLinks = postDiv.querySelectorAll('.user-profile-link');
      profileLinks.forEach(link => {
        link.onclick = (e) => {
          e.stopPropagation(); // Prevent any parent click handlers
          const username = link.dataset.username;
          if (username) {
            window.location.href = `profile.html?user=${encodeURIComponent(username)}`;
          }
        };
      });
      
      // Setup carousel for this post if multiple images
      if (imageUrls.length > 1) {
        const prevBtn = document.getElementById(`prevImgBtn-${index}`);
        const nextBtn = document.getElementById(`nextImgBtn-${index}`);
        const postImg = document.getElementById(`postImage-${index}`);
        
        prevBtn.onclick = function() {
          currentImgIndex = (currentImgIndex - 1 + imageUrls.length) % imageUrls.length;
          postImg.src = imageUrls[currentImgIndex];
        };
        
        nextBtn.onclick = function() {
          currentImgIndex = (currentImgIndex + 1) % imageUrls.length;
          postImg.src = imageUrls[currentImgIndex];
        };
      } else {
        // Hide arrows if only one image
        document.getElementById(`prevImgBtn-${index}`).style.display = 'none';
        document.getElementById(`nextImgBtn-${index}`).style.display = 'none';
      }
      
      // Setup like button
      let liked = false;
      const likeBtn = document.getElementById(`likeBtn-${index}`);
      const likeIcon = document.getElementById(`likeIcon-${index}`);
      const likeCountSpan = document.getElementById(`likeCount-${index}`);
      likeBtn.onclick = function() {
        liked = !liked;
        likeIcon.textContent = liked ? "‚ù§Ô∏è" : "ü§ç";
        const currentCount = parseInt(likeCountSpan.textContent.match(/\d+/)?.[0] || 0);
        likeCountSpan.textContent = liked ? `(${currentCount + 1})` : `(${currentCount})`;
      };
      
      // Setup delete button if it exists (only for owner)
      if (isOwner) {
        const deleteBtn = document.getElementById(`deleteBtn-${index}`);
        if (deleteBtn) {
          deleteBtn.onclick = async function() {
            if (!confirm('Are you sure you want to delete this post?')) {
              return;
            }
            
            try {
              const postId = postDiv.dataset.postId;
              if (!postId) {
                alert('Post ID not found');
                return;
              }
              
              const token = localStorage.getItem('token');
              const res = await fetch(`${API_BASE_URL}/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (res.status === 401) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
              }
              
              if (!res.ok) {
                const error = await res.json();
                alert('Failed to delete post: ' + (error.error || 'Unknown error'));
                return;
              }
              
              // Remove post from DOM
              postDiv.remove();
              
              // Reload posts to refresh the feed
              loadPosts();
            } catch (err) {
              console.error('Error deleting post:', err);
              alert('Failed to delete post. Please try again.');
            }
          };
        }
      }
    }

    // Load posts on page load
    loadPosts();
    
    // Note: Community filter removed from home page - home feed shows only followed users' posts

    // Load suggestions on page load
    async function loadSuggestions() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/users/suggestions`, {
          headers: getAuthHeaders()
        });
        
        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }
        
        if (!res.ok) {
          throw new Error('Failed to load suggestions');
        }
        
        const data = await res.json();
        const users = data.users || [];
        const suggestionsList = document.getElementById('suggestionsList');
        suggestionsList.innerHTML = '';
        
        users.forEach(user => {
          const li = document.createElement('li');
          const displayName = user.fullName || user.username;
          li.textContent = displayName;
          li.style.cursor = 'pointer';
          li.onclick = () => {
            // Navigate to profile or start conversation
            window.location.href = `profile.html?user=${user.username}`;
          };
          suggestionsList.appendChild(li);
        });
      } catch (err) {
        console.error('Error loading suggestions:', err);
      }
    }
    
    loadSuggestions();

    // User search bar logic - searches all users
    const userSearchInput = document.getElementById('userSearchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    let searchTimeout = null;
    
    userSearchInput.addEventListener('input', function() {
      const val = userSearchInput.value.trim();
      searchSuggestions.innerHTML = '';
      
      // Clear previous timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (val.length === 0) {
        searchSuggestions.style.display = 'none';
        return;
      }
      
      // Debounce search
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`${API_BASE_URL}/api/users/search?q=${encodeURIComponent(val)}`, {
            headers: getAuthHeaders()
          });
          
          if (res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
            return;
          }
          
          if (!res.ok) {
            throw new Error('Failed to search users');
          }
          
          const data = await res.json();
          const users = data.users || [];
          
          if (users.length === 0) {
            searchSuggestions.style.display = 'none';
            return;
          }
          
          users.forEach(user => {
            const li = document.createElement('li');
            const displayName = user.fullName || user.username;
            li.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px;">
                <img src="${user.avatarUrl ? (user.avatarUrl.startsWith('http') ? user.avatarUrl : API_BASE_URL + user.avatarUrl) : ''}" 
                     style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #4ac467;" />
                <span>${displayName}</span>
              </div>
            `;
            li.onclick = () => {
              userSearchInput.value = '';
              searchSuggestions.style.display = 'none';
              window.location.href = `profile.html?user=${user.username}`;
            };
            searchSuggestions.appendChild(li);
          });
          
          searchSuggestions.style.display = 'block';
        } catch (err) {
          console.error('Error searching users:', err);
        }
      }, 300);
    });
    
    document.addEventListener('click', function(event) {
      if (!userSearchInput.contains(event.target) && !searchSuggestions.contains(event.target)) {
        searchSuggestions.style.display = 'none';
      }
    });
  </script>
  <script src="https://cdn.botpress.cloud/webchat/v3.3/inject.js"></script>
<style>
  #webchat .bpWebchat {
    position: unset;
    width: 100%;
    height: 100%;
    max-height: 100%;
    max-width: 100%;
  }

  #webchat .bpFab {
    display: none;
  }
</style>

<!-- Put this on your page BEFORE the script below -->
<div id="webchat" style="width: 500px; height: 500px;"></div>

<!-- In your <body> tag -->
<script>
  window.botpress.on("webchat:ready", () => {
    window.botpress.open();
  });
  window.botpress.init({
  "botId": "f31f6881-59bb-434f-9346-8bc55b1e65a1",
  "configuration": {
    "version": "v2",
    "website": {},
    "email": {},
    "phone": {},
    "termsOfService": {},
    "privacyPolicy": {},
    "color": "#3276EA",
    "variant": "solid",
    "headerVariant": "glass",
    "themeMode": "light",
    "fontFamily": "inter",
    "radius": 4,
    "feedbackEnabled": false,
    "footer": "[‚ö° by Botpress](https://botpress.com/?from=webchat)",
    "soundEnabled": false,
    "proactiveMessageEnabled": false,
    "proactiveBubbleMessage": "Hi! üëã Need help?",
    "proactiveBubbleTriggerType": "afterDelay",
    "proactiveBubbleDelayTime": 10
  },
  "clientId": "112d80af-0364-4c56-9433-3254c293d1e4",
  "selector": "#webchat"
});
</script>
</body> 
</html>
    
