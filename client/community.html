<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community | Farmer Network</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #a8e6a3, #eafbea);
      margin: 0;
      font-family: "Poppins", "Segoe UI", Arial, sans-serif;
    }
    .profile-container {
      display: flex;
      min-height: 100vh;
    }
    .profile-sidebar {
      width: 220px;
      background: #eef7ee;
      padding: 28px 0 20px 0;
      box-shadow: 2px 0 18px rgba(30,60,38,0.07);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .sidebar-logo-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 28px;
    }
    .sidebar-logo {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      margin-bottom: 7px;
    }
    .sidebar-name {
      font-size: 1.27em;
      color: #226c38;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .sidebar-nav-link {
      display: block;
      padding: 15px 28px;
      font-size: 1.13em;
      color: #185f31;
      text-decoration: none;
      font-weight: 600;
      border-left: 4px solid transparent;
      transition: background 0.11s, border-color 0.15s;
      margin-bottom: 4px;
    }
    .sidebar-nav-link:hover, .sidebar-nav-link.active {
      background: #d2efda;
      border-left: 4px solid #31ad47;
      color: #145328;
    }

    .community-main-content {
      flex: 1;
      padding: 35px 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background-color: #2e7d32;
      color: white;
      text-align: center;
      padding: 20px 0;
      font-size: 26px;
      font-weight: bold;
      border-radius: 12px;
      width: 96%;
      max-width: 1000px;
      margin-bottom: 25px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.12);
    }
    form {
      background-color: #ffffff;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      width: 96%;
      max-width: 600px;
      margin-bottom: 35px;
    }
    form label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
      font-size: 17px;
    }
    form input, form select, form textarea, form button {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 18px;
      font-size: 16px;
      transition: 0.3s ease;
    }
    form input:focus, form select:focus, form textarea:focus {
      border-color: #27ae60;
      box-shadow: 0 0 8px rgba(39, 174, 96, 0.3);
      outline: none;
    }
    form button {
      background-color: #27ae60;
      color: white;
      font-size: 17px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.4s ease;
      box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
    }
    form button:hover {
      background-color: #1e8d4c;
      box-shadow: 0 0 20px rgba(39, 174, 96, 0.7);
      transform: scale(1.03);
    }

    .community-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 30px;
      width: 96%;
      max-width: 1000px;
    }
    .community-btn {
      padding: 12px 24px;
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
      background-color: #27ae60;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
      text-transform: capitalize;
    }
    .community-btn:hover {
      background-color: #1e8d4c;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }
    .community-btn.active {
      background-color: #1b5e20;
      box-shadow: 0 4px 12px rgba(27, 94, 32, 0.5);
    }
    .community-posts-container {
      width: 96%;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .sample-post {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 20px 24px;
      background: #fff;
      margin-bottom: 20px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.06);
      position: relative;
    }
    .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #2f8f3a;
    }
    .username {
      font-weight: 700;
      font-size: 1em;
      color: #127042;
    }
    .image-carousel {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
    }
    .carousel-arrow {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #156343;
      padding: 6px 10px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .carousel-arrow:active {
      background: #eafbe6;
    }
    .left-arrow { margin-right: 12px; }
    .right-arrow { margin-left: 12px; }
    #postImage {
      max-width: 400px;
      max-height: 250px;
      border-radius: 6px;
      border: 1.5px solid #dbe9d4;
      box-shadow: 0 2px 8px rgba(60,80,67,.08);
      background: #f8faf7;
      margin: 0 10px;
    }
    .action-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin:12px 0 8px 0;
      font-size: 1em;
      color:#111;
      font-weight:500;
      user-select:none;
    }
    .action-btn {
      background: none;
      border: none;
      padding: 3px 11px 3px 1px;
      cursor: pointer;
      font-size: 1.27em;
      margin-right: 2px;
      vertical-align: middle;
    }
    .action-bar .like-count, .action-bar .comment-count {
      font-size:1.07em;
      font-weight:500;
      margin-left:4px;
      margin-right: 18px;
      vertical-align:middle;
    }
    .action-bar .comment-count { margin-left: 2px; }
    .action-bar .like-label, .action-bar .comment-label {
      margin-left: 1px;
      font-weight:500;
      font-size:1.09em;
      margin-right:2px;
      vertical-align:middle;
    }
    .post-footer {
      margin-top: 12px;
    }
    .post-footer-username {
      font-weight: 700;
      color: #127042;
      font-size: 0.95em;
      margin-bottom: 4px;
    }
    .post-caption {
      color: #333;
      font-size: 0.9em;
      line-height: 1.4;
    }
    .caption-username {
      font-weight: 700;
      color: #127042;
    }
    .post-community-badge {
      display: inline-block;
      padding: 3px 10px;
      background: #38a653;
      color: #fff;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: capitalize;
    }
    .community-section-header {
      background: linear-gradient(135deg, #2e7d32, #1b5e20);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      text-transform: capitalize;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }
    .community-posts-group {
      margin-bottom: 40px;
    }
    footer {
      text-align: center;
      padding: 15px;
      color: #333;
      font-size: 15px;
      margin-top: 20px;
    }
    @media (max-width: 900px) {
      .profile-container { flex-direction: column; }
      .profile-sidebar { flex-direction: row; width: 100vw; padding: 0 0 0 18px; }
      .sidebar-nav { flex-direction: row; overflow-x: auto; }
      .sidebar-nav-link { padding: 11px 10px; margin-bottom: 0; }
    }
  </style>
</head>
<body>

  <div class="profile-container">
    <!-- Sidebar -->
    <aside class="profile-sidebar">
      <div class="sidebar-logo-block">
        <img src="img.jpg" alt="Farmer Logo" class="sidebar-logo"/>
        <span class="sidebar-name">Farmer Network</span>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="sidebar-nav-link"><i class="fa fa-home"></i> Home</a>
        <a href="profile.html" class="sidebar-nav-link"><i class="fa fa-user"></i> Profile</a>
        <a href="messages.html" class="sidebar-nav-link"><i class="fa fa-envelope"></i> Messages</a>
        <a href="weather.html" class="sidebar-nav-link"><i class="fa fa-cloud-sun"></i> Weather</a>
        <a href="resources.html" class="sidebar-nav-link"><i class="fa fa-book"></i> Resources</a>
        <a href="community.html" class="sidebar-nav-link active"><i class="fa fa-users"></i> Community</a>
        <a href="tips.html" class="sidebar-nav-link"><i class="fa fa-lightbulb"></i> Tips</a>
        <a href="Feedback.html" class="sidebar-nav-link"><i class="fa fa-star"></i> Feedback</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="community-main-content">
      <header>üåæ Farmer Community Network üåæ</header>

      <div id="communityList" class="community-selector"></div>

      <div id="communityPostsContainer" class="community-posts-container"></div>

      <footer>¬© 2025 Farmer-to-Farmer Knowledge Network üå±</footer>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:4000';
    
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }
    
    // Helper function to get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      };
    }
    
    // Placeholder image URL for posts without images
    const PLACEHOLDER_IMAGE_URL = 'https://via.placeholder.com/600x400?text=No+Image';
    
    let currentCommunity = '';
    
    // Load posts filtered by community
    async function loadCommunityPosts(community = '') {
      try {
        let url = `${API_BASE_URL}/api/posts`;
        if (community && community.trim()) {
          url += `?community=${encodeURIComponent(community.trim())}`;
        }
        
        console.log('Loading posts from:', url);
        
        let res;
        try {
          res = await fetch(url);
        } catch (fetchError) {
          console.error('Network error:', fetchError);
          throw new Error('Network error: Could not connect to server. Please check if the server is running.');
        }
        
        if (!res.ok) {
          const text = await res.text();
          console.error('Community posts error:', res.status, text);
          let errorData;
          try {
            errorData = JSON.parse(text);
          } catch (parseError) {
            errorData = { error: `Server returned status ${res.status}: ${text}` };
          }
          throw new Error(errorData.error || `Failed to load posts (${res.status})`);
        }
        
        let data;
        try {
          data = await res.json();
        } catch (parseError) {
          console.error('Failed to parse response:', parseError);
          throw new Error('Invalid response from server');
        }
        
        console.log('Posts loaded:', data.posts?.length || 0);
        const posts = data.posts || [];
        
        // Clear existing posts
        const container = document.getElementById('communityPostsContainer');
        if (!container) {
          console.error('Container not found');
          return;
        }
        container.innerHTML = '';
        
        if (posts.length === 0) {
          const message = community && community.trim() 
            ? `No posts yet for ${community.charAt(0).toUpperCase() + community.slice(1)} community.`
            : 'No posts found in any community.';
          container.innerHTML = `<p style="text-align: center; color: #666; font-size: 1.1em; padding: 30px;">${message}</p>`;
          return;
        }
        
        // Group posts by community
        const postsByCommunity = {};
        posts.forEach(post => {
          const comm = (post.community || '').toLowerCase();
          if (comm && comm !== 'other') {
            if (!postsByCommunity[comm]) {
              postsByCommunity[comm] = [];
            }
            postsByCommunity[comm].push(post);
          }
        });
        
        // Render posts grouped by community
        const validCommunities = ['wheat', 'corn', 'rice', 'fruits', 'vegetables'];
        let postIndex = 0;
        
        if (community && community.trim()) {
          // Show only selected community with header
          const normalizedComm = community.trim().toLowerCase();
          const commPosts = postsByCommunity[normalizedComm] || [];
          if (commPosts.length > 0) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'community-posts-group';
            groupDiv.innerHTML = `<div class="community-section-header">${normalizedComm.charAt(0).toUpperCase() + normalizedComm.slice(1)} Community</div>`;
            const postsContainer = document.createElement('div');
            postsContainer.style.display = 'flex';
            postsContainer.style.flexDirection = 'column';
            postsContainer.style.alignItems = 'center';
            commPosts.forEach(post => {
              renderPost(post, postIndex++, postsContainer);
            });
            groupDiv.appendChild(postsContainer);
            container.appendChild(groupDiv);
          } else {
            container.innerHTML = `<p style="text-align: center; color: #666; font-size: 1.1em; padding: 30px;">No posts yet for ${normalizedComm.charAt(0).toUpperCase() + normalizedComm.slice(1)} community.</p>`;
          }
        } else {
          // Show all communities grouped
          validCommunities.forEach(comm => {
            const commPosts = postsByCommunity[comm] || [];
            if (commPosts.length > 0) {
              const groupDiv = document.createElement('div');
              groupDiv.className = 'community-posts-group';
              groupDiv.innerHTML = `<div class="community-section-header">${comm.charAt(0).toUpperCase() + comm.slice(1)} Community</div>`;
              const postsContainer = document.createElement('div');
              postsContainer.style.display = 'flex';
              postsContainer.style.flexDirection = 'column';
              postsContainer.style.alignItems = 'center';
              commPosts.forEach(post => {
                renderPost(post, postIndex++, postsContainer);
              });
              groupDiv.appendChild(postsContainer);
              container.appendChild(groupDiv);
            }
          });
        }
      } catch (err) {
        console.error('Error loading posts:', err);
        const container = document.getElementById('communityPostsContainer');
        if (container) {
          // Only show error message for actual errors, not empty results
          const errorMessage = err.message || 'Failed to load posts. Please try again.';
          container.innerHTML = `<p style="text-align: center; color: #d32f2f; font-size: 1.1em; padding: 30px;">${errorMessage}</p>`;
        }
      }
    }
    
    // Render a single post
    function renderPost(post, index, container) {
      const postDiv = document.createElement('div');
      postDiv.className = 'sample-post';
      postDiv.id = `post-${index}`;
      
      // Build image URLs
      const images = post.images && post.images.length > 0 
        ? post.images.map(img => img.startsWith('http') ? img : API_BASE_URL + img)
        : [PLACEHOLDER_IMAGE_URL];
      
      const imageUrls = images.map(img => img.startsWith('http') ? img : API_BASE_URL + img);
      // Use a closure to track image index per post
      let currentImgIndex = 0;
      
      // Check if current user owns this post
      const currentUsername = localStorage.getItem('username');
      const isOwner = post.username === currentUsername;
      const deleteButton = isOwner ? `<button class="delete-post-btn" id="deleteBtn-${index}" title="Delete post" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: auto; font-size: 0.9em;">üóëÔ∏è Delete</button>` : '';
      
      postDiv.innerHTML = `
        <div class="user-row" style="display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" class="user-profile-link" data-username="${post.username || ''}">
            <img class="avatar" src="${post.avatarUrl ? (post.avatarUrl.startsWith('http') ? post.avatarUrl : API_BASE_URL + post.avatarUrl) : ''}" alt="User photo" />
            <span class="username">${post.username || ''}</span>
          </div>
          ${deleteButton}
        </div>
        ${post.community ? `<div class="post-community-badge">${post.community}</div>` : ''}
        <div class="image-carousel">
          <button class="carousel-arrow left-arrow" id="prevImgBtn-${index}">&#8592;</button>
          <img id="postImage-${index}" src="${imageUrls[currentImgIndex]}" alt="Post image" />
          <button class="carousel-arrow right-arrow" id="nextImgBtn-${index}">&#8594;</button>
        </div>
        <div class="action-bar">
          <button class="action-btn" id="likeBtn-${index}" title="Like">
            <span id="likeIcon-${index}">ü§ç</span>
          </button>
          <span class="like-label">Like</span>
          <span class="like-count" id="likeCount-${index}">(0)</span>
          <button class="action-btn" id="commentBtn-${index}" title="Comments">
            <span>üí¨</span>
          </button>
          <span class="comment-label">Comment</span>
          <span class="comment-count" id="commentCount-${index}">(0)</span>
        </div>
        <div class="post-footer">
          <div class="post-footer-username user-profile-link" data-username="${post.username || ''}" style="cursor: pointer;">${post.username || ''}</div>
          <div class="post-caption">
            <span class="caption-username user-profile-link" data-username="${post.username || ''}" style="cursor: pointer;">${post.username || ''}</span>
            <span class="caption-text">${post.caption || ''}</span>
          </div>
        </div>
      `;
      
      postDiv.dataset.postId = post._id;
      container.appendChild(postDiv);
      
      // Setup carousel for this post if multiple images
      if (imageUrls.length > 1) {
        const prevBtn = document.getElementById(`prevImgBtn-${index}`);
        const nextBtn = document.getElementById(`nextImgBtn-${index}`);
        const postImg = document.getElementById(`postImage-${index}`);
        
        // Use closure to maintain separate index for each post
        (function(imgIndex) {
          prevBtn.onclick = function() {
            imgIndex = (imgIndex - 1 + imageUrls.length) % imageUrls.length;
            postImg.src = imageUrls[imgIndex];
          };
          
          nextBtn.onclick = function() {
            imgIndex = (imgIndex + 1) % imageUrls.length;
            postImg.src = imageUrls[imgIndex];
          };
        })(0);
      } else {
        // Hide arrows if only one image
        const prevBtn = document.getElementById(`prevImgBtn-${index}`);
        const nextBtn = document.getElementById(`nextImgBtn-${index}`);
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
      }
      
      // Setup like button
      let liked = false;
      const likeBtn = document.getElementById(`likeBtn-${index}`);
      const likeIcon = document.getElementById(`likeIcon-${index}`);
      const likeCountSpan = document.getElementById(`likeCount-${index}`);
      likeBtn.onclick = function() {
        liked = !liked;
        likeIcon.textContent = liked ? "‚ù§Ô∏è" : "ü§ç";
        const currentCount = parseInt(likeCountSpan.textContent.match(/\d+/)?.[0] || 0);
        likeCountSpan.textContent = liked ? `(${currentCount + 1})` : `(${currentCount})`;
      };
      
      // Setup delete button if it exists
      if (isOwner) {
        const deleteBtn = document.getElementById(`deleteBtn-${index}`);
        if (deleteBtn) {
          deleteBtn.onclick = async function() {
            if (!confirm('Are you sure you want to delete this post?')) {
              return;
            }
            
            try {
              const postId = postDiv.dataset.postId;
              if (!postId) {
                alert('Post ID not found');
                return;
              }
              
              const token = localStorage.getItem('token');
              const res = await fetch(`${API_BASE_URL}/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (res.status === 401) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
              }
              
              if (!res.ok) {
                const error = await res.json();
                alert('Failed to delete post: ' + (error.error || 'Unknown error'));
                return;
              }
              
              // Remove post from DOM
              postDiv.remove();
              
              // Reload posts
              loadCommunityPosts(currentCommunity);
            } catch (err) {
              console.error('Error deleting post:', err);
              alert('Failed to delete post. Please try again.');
            }
          };
        }
      }
      
      // Add click handlers for profile links
      const profileLinks = postDiv.querySelectorAll('.user-profile-link');
      profileLinks.forEach(link => {
        link.onclick = (e) => {
          e.stopPropagation();
          const username = link.dataset.username;
          if (username) {
            window.location.href = `profile.html?user=${encodeURIComponent(username)}`;
          }
        };
      });
    }
    
    // Load available communities dynamically
    async function loadCommunities() {
      const communityList = document.getElementById('communityList');
      if (!communityList) {
        console.error('Community list container not found');
        return;
      }
      
      try {
        console.log('Loading communities from:', `${API_BASE_URL}/api/posts/communities`);
        const res = await fetch(`${API_BASE_URL}/api/posts/communities`);
        
        if (!res.ok) {
          console.warn('Failed to load communities, using fallback');
          throw new Error('Failed to load communities');
        }
        
        const data = await res.json();
        console.log('Communities loaded:', data);
        const communities = data.communities || [];
        
        communityList.innerHTML = '';
        
        // Add "All" button
        const allBtn = document.createElement('button');
        allBtn.className = 'community-btn active';
        allBtn.dataset.community = '';
        allBtn.textContent = 'All Communities';
        allBtn.onclick = function() {
          document.querySelectorAll('.community-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentCommunity = '';
          loadCommunityPosts('');
        };
        communityList.appendChild(allBtn);
        
        // Add buttons for each community
        communities.forEach(comm => {
          const btn = document.createElement('button');
          btn.className = 'community-btn';
          btn.dataset.community = comm.community;
          
          // Add emoji based on community
          const emojiMap = {
            'wheat': 'üåæ',
            'corn': 'üåΩ',
            'rice': 'üçö',
            'fruits': 'üçé',
            'vegetables': 'ü•¨'
          };
          const emoji = emojiMap[comm.community] || '';
          
          btn.textContent = `${emoji} ${comm.community.charAt(0).toUpperCase() + comm.community.slice(1)} (${comm.count})`;
          btn.onclick = function() {
            document.querySelectorAll('.community-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCommunity = comm.community;
            loadCommunityPosts(comm.community);
          };
          communityList.appendChild(btn);
        });
      } catch (err) {
        console.error('Error loading communities:', err);
        // Fallback to hardcoded communities if API fails
        const fallbackCommunities = [
          { community: 'wheat', emoji: 'üåæ' },
          { community: 'corn', emoji: 'üåΩ' },
          { community: 'rice', emoji: 'üçö' },
          { community: 'fruits', emoji: 'üçé' },
          { community: 'vegetables', emoji: 'ü•¨' }
        ];
        
        communityList.innerHTML = '';
        
        const allBtn = document.createElement('button');
        allBtn.className = 'community-btn active';
        allBtn.dataset.community = '';
        allBtn.textContent = 'All Communities';
        allBtn.onclick = function() {
          document.querySelectorAll('.community-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentCommunity = '';
          loadCommunityPosts('');
        };
        communityList.appendChild(allBtn);
        
        fallbackCommunities.forEach(comm => {
          const btn = document.createElement('button');
          btn.className = 'community-btn';
          btn.dataset.community = comm.community;
          btn.textContent = `${comm.emoji} ${comm.community.charAt(0).toUpperCase() + comm.community.slice(1)}`;
          btn.onclick = function() {
            document.querySelectorAll('.community-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCommunity = comm.community;
            loadCommunityPosts(comm.community);
          };
          communityList.appendChild(btn);
        });
      }
    }
    
    // Setup community selector buttons
    document.addEventListener('DOMContentLoaded', async () => {
      // Verify API_BASE_URL is set
      if (!API_BASE_URL) {
        console.error('API_BASE_URL is not defined');
        const container = document.getElementById('communityPostsContainer');
        if (container) {
          container.innerHTML = '<p style="text-align: center; color: #d32f2f; font-size: 1.1em; padding: 30px;">Configuration error: API URL not set.</p>';
        }
        return;
      }
      
      // Test server connectivity
      try {
        const testRes = await fetch(`${API_BASE_URL}/`);
        console.log('Server connectivity test:', testRes.status);
      } catch (err) {
        console.error('Server not reachable:', err);
        const container = document.getElementById('communityPostsContainer');
        if (container) {
          container.innerHTML = '<p style="text-align: center; color: #d32f2f; font-size: 1.1em; padding: 30px;">Cannot connect to server. Please ensure the server is running on ' + API_BASE_URL + '</p>';
        }
        return;
      }
      
      // Load communities dynamically
      await loadCommunities();
      
      // Load all posts initially (grouped by community)
      loadCommunityPosts('');
    });
  </script>

</body>
</html>
